{"version":3,"file":"gltf-transform-split.umd.js","sources":["../src/index.ts"],"sourcesContent":["import { GLTFContainer, GLTFUtil, LoggerVerbosity } from 'gltf-transform-util';\n\nconst splice = (buffer: ArrayBuffer, begin: number, count: number): Array<ArrayBuffer> => {\n  const a1 = buffer.slice(0, begin);\n  const a2 = buffer.slice(begin + count);\n  const a = join(a1, a2);\n  const b = buffer.slice(begin, begin + count);\n  return [a, b];\n};\n\nconst join = (a: ArrayBuffer, b: ArrayBuffer): ArrayBuffer => {\n  const out = new Uint8Array(a.byteLength + b.byteLength);\n  out.set(new Uint8Array(a), 0);\n  out.set(new Uint8Array(b), a.byteLength);\n  return out.buffer;\n}\n\nconst split = function (container: GLTFContainer, meshes: Array<string>): GLTFContainer {\n\n  const json = container.json;\n  const logger = GLTFUtil.createLogger('gltf-transform-split', LoggerVerbosity.INFO);\n\n  // Create Buffer instances.\n  json.buffers.forEach((buffer, bufferIndex) => {\n    if (buffer.uri && buffer.uri.match(/^data:/)) {\n      const uri = buffer.uri;\n      buffer.uri = `buffer${bufferIndex}.bin`;\n      buffer['_buffer'] = GLTFUtil.createBufferFromDataURI(uri);\n      return;\n    }\n    throw new Error('Only buffers using Data URIs are currently supported');\n  });\n\n  const bufferViewMap = {};\n\n  // Group bufferviews by mesh.\n  json.meshes.forEach((mesh) => {\n    if (meshes.indexOf(mesh.name) === -1) return;\n    mesh.primitives.forEach((prim) => {\n      if (prim.indices) markAccessor(json.accessors[prim.indices]);\n      Object.keys(prim.attributes).forEach((attrName) => {\n        markAccessor(json.accessors[prim.attributes[attrName]]);\n      });\n\n      function markAccessor(accessor) {\n        const bufferView = json.bufferViews[accessor.bufferView];\n        if (bufferViewMap[accessor.bufferView] === undefined) {\n          bufferViewMap[accessor.bufferView] = mesh.name;\n        } else if (bufferViewMap[accessor.bufferView] !== mesh.name) {\n          throw new Error('Not implemented: Two meshes share a bufferview.');\n        }\n      };\n    });\n  });\n\n  // Write data for each mesh to a new buffer.\n  meshes.forEach((meshName) => {\n    let buffer = GLTFUtil.createBuffer();\n\n    logger.info(`ðŸ“¦  ${meshName}`);\n\n    json.bufferViews.forEach((bufferView, bufferViewIndex) => {\n      if (bufferViewMap[bufferViewIndex] !== meshName) return;\n      logger.info(meshName + ':' + bufferViewIndex);\n\n      // Extract data from original buffer.\n      logger.info(`original before: ${json.buffers[bufferView.buffer]['_buffer'].byteLength} w/ offset ${bufferView.byteOffset} and length ${bufferView.byteLength}`);\n      const [ original, tmp ] = splice(json.buffers[bufferView.buffer]['_buffer'], bufferView.byteOffset, bufferView.byteLength);\n      logger.info(`spliced: ${tmp.byteLength}`);\n      json.buffers[bufferView.buffer]['_buffer'] = original;\n      logger.info(`original after: ${json.buffers[bufferView.buffer]['_buffer'].byteLength}`);\n\n      // Write data to new buffer.\n      const affectedByteOffset = bufferView.byteOffset + bufferView.byteLength;\n      const affectedBuffer = bufferView.buffer;\n      bufferView.byteOffset = buffer.byteLength;\n      bufferView.buffer = json.buffers.length;\n      buffer = join(buffer, tmp);\n\n      // Update remaining buffers.\n      json.bufferViews.forEach((affectedBufferView) => {\n        if (affectedBufferView.buffer === affectedBuffer\n          && affectedBufferView.byteOffset >= affectedByteOffset) {\n          affectedBufferView.byteOffset -= bufferView.byteLength;\n        }\n      });\n      // TODO: Update embedded images, or throw an error.\n    });\n\n    const meshBuffer = { uri: `${meshName}.bin`, byteLength: undefined } as GLTF.IBuffer;\n    meshBuffer['_buffer'] = buffer;\n    json.buffers.push(meshBuffer);\n  });\n\n  // Filter out empty buffers.\n  json.buffers = json.buffers.filter((buffer, bufferIndex) => {\n    buffer.byteLength = buffer['_buffer'].byteLength;\n    delete buffer['_buffer'];\n    if (buffer.byteLength > 0) return true;\n    json.bufferViews.forEach((bufferView) => {\n      if (bufferView.buffer >= bufferIndex) bufferView.buffer--;\n    });\n    return false;\n  });\n\n  return container;\n}\n\nconst test = 'test';\n\nexport { split, test };\n"],"names":["GLTFUtil","LoggerVerbosity"],"mappings":"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"}