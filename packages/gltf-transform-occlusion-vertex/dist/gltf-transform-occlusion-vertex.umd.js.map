{"version":3,"file":"gltf-transform-occlusion-vertex.umd.js","sources":["../node_modules/geo-ambient-occlusion/index.js","../src/index.ts"],"sourcesContent":["'use strict';\n\n\nconst REGL = require('regl');\nconst mat4 = require('gl-matrix').mat4;\nconst center = require('geo-center');\nconst boundingBox = require('vertices-bounding-box');\nconst transform = require('geo-3d-transform-mat4');\nconst converter = require('geo-convert-position-format');\nconst vertexNormals = require('normals').vertexNormals;\nconst reindex = require('mesh-reindex');\nconst defaults = require('defaults');\n\n\nmodule.exports = function(positions, opts) {\n\n  opts = defaults(opts, {\n    cells: undefined,\n    regl: false,\n    bias: 0.01,\n    resolution: 512\n  });\n\n  // Center the mesh on the origin (and make a copy in the process).\n  positions = center(positions);\n\n  // Scale the mesh to a 1x1x1 cube.\n  const bb = boundingBox(positions);\n  const scale = [\n    1 / (bb[1][0] - bb[0][0]),\n    1 / (bb[1][1] - bb[0][1]),\n    1 / (bb[1][2] - bb[0][2]),\n  ];\n  const scaleMat4 = mat4.scale([], mat4.create(), scale);\n  positions = transform(positions, scaleMat4);\n\n  // Create an array with the vertex data.\n  const vertexData = converter.convert(positions, converter.TYPED_ARRAY);\n\n  // Create normals.\n  let mesh = {\n    cells: opts.cells,\n    positions: positions,\n  };\n  if (mesh.cells === undefined) {\n    mesh = reindex(vertexData);\n  }\n  const normals = vertexNormals(mesh.cells, mesh.positions, 0);\n  const normalData = converter.convert(normals, converter.TYPED_ARRAY);\n\n  // Make sure the position array is divisible by three.\n  if (vertexData.length % 3 !== 0) {\n    throw new Error('geo-ambient-occlusion: Position array not divisible by three.');\n  }\n\n  // Copy it into the smallest POT-length array we can.\n  const vertexCount = vertexData.length/3;\n  let vertexTextureRes = 1;\n  while (vertexTextureRes * vertexTextureRes < vertexCount) {\n    vertexTextureRes *= 2;\n  }\n  const vertexDataArray = new Float32Array(vertexTextureRes * vertexTextureRes * 3);\n  vertexDataArray.set(vertexData);\n\n  // Copy the normal data into a same-size array.\n  const normalDataArray = new Float32Array(vertexTextureRes * vertexTextureRes * 3);\n  normalDataArray.set(normalData);\n\n  // Figure out what extensions we need.\n  const extensions = ['OES_texture_float'];\n  if (vertexCount > 65535 && opts.cells !== undefined) {\n    extensions.push('OES_element_index_uint');\n  }\n\n  // If we are given a regl context, make sure it has the extensions we need.\n  if (opts.regl) {\n    for (let ext of extensions) {\n      if (!opts.regl.hasExtension(ext)) {\n        throw new Error('geo-ambient-occlusion: Provided regl context needs the ' + ext + ' extension for this mesh.');\n      }\n    }\n  }\n\n  // If we don't have a regl context, create one.\n  let regl, ownregl;\n  if (opts.regl) {\n    regl = opts.regl;\n    ownregl = false;\n  } else {\n    regl = REGL({\n      canvas: document.createElement('canvas'),\n      extensions: extensions,\n    });\n    ownregl = true;\n  }\n\n  // Define a framebuffer for our position data.\n  const fboPosition = fbo(opts.resolution);\n\n  // Define the command that gathers the position data.\n  const cmdPositionObj = {\n    vert: `\n      precision highp float;\n      attribute vec3 position;\n      uniform mat4 model, projection;\n      varying vec3 vPos;\n      void main() {\n        gl_Position = projection * model * vec4(position, 1);\n        vPos = vec3(model * vec4(position, 1));\n      }\n    `,\n    frag: `\n      precision highp float;\n      varying vec3 vPos;\n      void main() {\n        gl_FragColor = vec4(vPos, 1);\n      }\n    `,\n    attributes: {\n      position: positions,\n    },\n    uniforms: {\n      model: regl.prop('model'),\n      projection: regl.prop('projection'),\n    },\n    viewport: {x: 0, y: 0, width: opts.resolution, height: opts.resolution},\n    framebuffer: fboPosition,\n  };\n  if (opts.cells) {\n    cmdPositionObj.elements = opts.cells;\n  } else {\n    cmdPositionObj.count = vertexCount;\n  }\n  const cmdPosition = regl(cmdPositionObj);\n\n  // Define a pair of buffers we'll ping-pong to accumulate occlusion data.\n  const fboOcclusion = [fbo(vertexTextureRes), fbo(vertexTextureRes)];\n\n  // Create a texture that stores our vertex locations.\n  const tVertex = regl.texture({\n    width: vertexTextureRes,\n    height: vertexTextureRes,\n    data: vertexDataArray,\n    format: 'rgb',\n    type: 'float'\n  });\n\n  // Create a texture that stores our normal directions.\n  const tNormal = regl.texture({\n    width: vertexTextureRes,\n    height: vertexTextureRes,\n    data: normalDataArray,\n    format: 'rgb',\n    type: 'float',\n  });\n\n  // Define the command for occlusion accumulation.\n  const cmdOcclusion = regl({\n    vert: `\n      precision highp float;\n      attribute vec2 position;\n      void main() {\n          gl_Position = vec4(position, 0, 1);\n      }\n    `,\n    frag: `\n      precision highp float;\n\n      uniform sampler2D tPosition, tSource, tVertex, tNormal;\n      uniform float count, bias;\n      uniform vec2 resolution;\n      uniform mat4 model;\n\n      const float INVSQRT3 = 0.5773502691896258; // 1/sqrt(3)\n\n      void main() {\n          vec2 texel = gl_FragCoord.xy/resolution;\n          vec3 vert = texture2D(tVertex, texel).rgb;\n          vert = vec3(model * vec4(vert, 1));\n          vec3 norm = texture2D(tNormal, texel).rgb;\n          norm = vec3(model * vec4(norm, 1));\n          float z = texture2D(tPosition, INVSQRT3 * vert.xy + 0.5).z;\n          float o = 0.0;\n          if ((vert.z - z) < -bias) {\n              o = 1.0;\n          }\n          vec4 src = texture2D(tSource, texel);\n          if (dot(norm, vec3(0,0,1)) > 0.0) {\n            gl_FragColor = src + vec4(o, 1, 0, 0);\n          } else {\n            gl_FragColor = src;\n          }\n      }\n    `,\n    attributes: {\n      position: [-1,-1, 1,-1, 1,1, -1,-1, 1,1, -1,1],\n    },\n    uniforms: {\n      tPosition: fboPosition,\n      tSource: regl.prop('source'),\n      tVertex: tVertex,\n      tNormal: tNormal,\n      count: regl.prop('count'),\n      bias: regl.prop('bias'),\n      resolution: [vertexTextureRes, vertexTextureRes],\n      model: regl.prop('model'),\n    },\n    viewport: {x: 0, y: 0, width: vertexTextureRes, height: vertexTextureRes},\n    framebuffer: regl.prop('destination'),\n    count: 6,\n  });\n\n  // Keep track of our ping-ponging.\n  let occlusionIndex = 0;\n\n  // Keep track of how many samples we've collected.\n  let occlusionCount = 0;\n\n  // set up our projection matrix.\n  const d = Math.sqrt(3)/2;\n  const projection = mat4.ortho([], -d, d, -d, d, -d, d);\n\n  // Take a single occlusion sample.\n  function sample() {\n    occlusionIndex = 1 - occlusionIndex;\n    const source = fboOcclusion[occlusionIndex];\n    const destination = fboOcclusion[1 - occlusionIndex];\n    occlusionCount++;\n    const model = mat4.create();\n    mat4.rotateX(model, model, Math.random() * 100);\n    mat4.rotateY(model, model, Math.random() * 100);\n    mat4.rotateZ(model, model, Math.random() * 100);\n    regl.clear({\n      color: [0,0,0,1],\n      depth: 1,\n      framebuffer: fboPosition,\n    });\n    cmdPosition({\n      model: model,\n      projection: projection,\n    });\n    regl.clear({\n      color: [0,0,0,1],\n      depth: 1,\n      framebuffer: destination,\n    });\n    cmdOcclusion({\n      source: source,\n      destination: destination,\n      count: occlusionCount,\n      bias: opts.bias,\n      model: model,\n    });\n  }\n\n\n  // Return the per-vertex ambient occlusion in a Float32Array of length vertexCount.\n  function report() {\n    // Gather the resulting pixels.\n    let pixels;\n    fboOcclusion[1 - occlusionIndex].use(() => {\n      pixels = regl.read();\n    });\n\n    // Format them and return the final product.\n    const result = new Float32Array(vertexCount);\n    for (let i = 0; i < vertexCount; i++) {\n      const index = i * 4;\n      const total = pixels[index + 1];\n      result[i] = total === 0.0 ? 0.0 : pixels[index + 0]/total;\n    }\n\n    return result;\n  }\n\n\n  // Dispose of all resources. Do not dispose of regl if we did not create it. Behavior after calling dispose is\n  // undefined.\n  function dispose() {\n    tVertex.destroy();\n    fboPosition.destroy();\n    fboOcclusion[0].destroy();\n    fboOcclusion[1].destroy();\n    if (ownregl) {\n      regl.destroy();\n    }\n  }\n\n\n  // Utility function for creating a common fbo.\n  function fbo(resolution) {\n    return regl.framebuffer({\n      width: resolution,\n      height: resolution,\n      colorFormat: 'rgba',\n      colorType: 'float',\n    });\n  }\n\n  return {\n    sample: sample,\n    report: report,\n    dispose: dispose\n  };\n};\n","import { GLTFContainer, GLTFUtil, LoggerVerbosity } from 'gltf-transform-util';\nimport * as geoaoNamespace from 'geo-ambient-occlusion';\n\nconst geoao = geoaoNamespace as Function;\nconst logger = GLTFUtil.createLogger('gltf-transform-occlusion-vertex', LoggerVerbosity.INFO);\n\ninterface IOcclusionOptions {\n    resolution: 512;\n    samples: 500;\n}\n\nfunction getTextureBuffer (): ArrayBuffer {\n    const canvas = document.createElement('canvas');\n    canvas.width = 256;\n    canvas.height = 1;\n    const ctx = canvas.getContext('2d');\n    const grd = ctx.createLinearGradient(0, 0, 255, 0);\n    grd.addColorStop(0, '#000');\n    grd.addColorStop(1, '#fff');\n    ctx.fillStyle = grd;\n    ctx.fillRect(0, 0, 256, 1);\n    const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);\n    return imgData.data.buffer;\n}\n\nlet aoTextureBuffer;\n\nfunction occlusionVertex (container: GLTFContainer, options: IOcclusionOptions): GLTFContainer {\n\n    aoTextureBuffer = aoTextureBuffer || getTextureBuffer();\n    const {resolution, samples} = options;\n    logger.info(`Resolution: ${resolution}; Samples: ${samples}`);\n\n    const primitives = [];\n    const meshes = container.json.meshes || [];\n    meshes.forEach((mesh) => {\n        mesh.primitives.forEach((primitive) => {\n            const position = container.getAccessorArray(primitive.attributes['POSITION']);\n            const cells = primitive.indices !== undefined ? container.getAccessorArray(primitive.indices) : undefined;\n            primitives.push({position, cells});\n        })\n    });    \n\n    if (primitives.length === 0) {\n        logger.warn('No primitives found.');\n        return;\n    }\n\n    container.addImage('occlusion.png', aoTextureBuffer, GLTF.ImageMimeType.PNG);\n    container.json.textures.push({source: container.json.images.length - 1});\n    const occlusionTextureIndex = container.json.textures.length - 1;\n    \n    // TODO: Implement baking such that primitives affect other primitives, and respect\n    // world transforms.\n    primitives.forEach((primitive, index) => {\n        logger.info(`Baking primitive ${index} / ${primitives.length}.`);\n\n        if (container.json.materials[primitive.material].occlusionTexture) {\n            // TODO: Duplicate the material if needed.\n            logger.error(`Primitive \"${primitive.name}\" material already has AO map, and may be shared by another primitive. Skipping.`);\n            return;\n        }\n\n        // Bake vertex AO.\n        const {position, cells} = primitive;\n        const aoSampler = geoao(position, {cells, resolution});\n        for (let i = 0; i < samples; i++) aoSampler.sample();\n        const ao = aoSampler.report();\n        aoSampler.dispose();\n\n        // Write UV set and add AO map.\n        const numVertices = ao.length;\n        const uv2Data = new Float32Array(numVertices * 2);\n        for (let i = 0; i < numVertices; i++) {\n            uv2Data[i * 2] = uv2Data[i * 2 + 1] = 1 - ao[i];\n        }\n        container.addAccessor(uv2Data, GLTF.AccessorType.VEC2, 12345);\n        primitive.attributes['TEXCOORD_1'] = container.json.accessors.length - 1;\n        if (primitive.attributes['TEXCOORD_0'] === undefined) {\n            primitive.attributes['TEXCOORD_0'] = container.json.accessors.length - 1;\n        }\n        container.json.materials[primitive.material].occlusionTexture = {index: occlusionTextureIndex};\n    });\n\n    logger.info('Finished baking per-vertex occlusion.');\n    return container;\n}\n\nexport { occlusionVertex };\n"],"names":["GLTFUtil","LoggerVerbosity"],"mappings":"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"}